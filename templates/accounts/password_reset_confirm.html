{% extends "base.html" %}
{% block title %}Nueva contrase√±a | Cl√≠nica{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-md-8 col-lg-6">

    <div class="card shadow-sm border-0">
      <div class="card-body p-4 p-md-5">

        {% if validlink %}
          <h1 class="h4 fw-bold mb-1">Nueva contrase√±a</h1>
          <p class="text-muted mb-4">Escribe tu nueva contrase√±a.</p>

          <form method="post" novalidate>
            {% csrf_token %}

            <div class="mb-3">
              <label class="form-label">Nueva contrase√±a</label>
              <div class="input-group">
                {{ form.new_password1 }}
                <button class="btn btn-outline-secondary" type="button" data-toggle="p1">üëÅÔ∏è</button>
              </div>
              {% if form.new_password1.errors %}
                <div class="text-danger small mt-1">{{ form.new_password1.errors }}</div>
              {% endif %}
            </div>

            <div class="mb-3">
              <label class="form-label">Confirmar contrase√±a</label>
              <div class="input-group">
                {{ form.new_password2 }}
                <button class="btn btn-outline-secondary" type="button" data-toggle="p2">üëÅÔ∏è</button>
              </div>
              {% if form.new_password2.errors %}
                <div class="text-danger small mt-1">{{ form.new_password2.errors }}</div>
              {% endif %}
            </div>

            <div class="d-grid">
              <button class="btn btn-dark btn-lg" type="submit">Guardar</button>
            </div>
          </form>
        {% else %}
          <h1 class="h4 fw-bold">Enlace inv√°lido</h1>
          <p class="text-muted mb-0">
            Este enlace ya fue usado o expir√≥. Solicita uno nuevo.
          </p>
          <div class="mt-3">
            <a class="btn btn-dark" href="{% url 'password_reset' %}">Pedir otro enlace</a>
          </div>
        {% endif %}

      </div>
    </div>

  </div>
</div>

<script>
  (function () {
    const p1 = document.querySelector('input[name="new_password1"]');
    const p2 = document.querySelector('input[name="new_password2"]');
    if (p1 && !p1.classList.contains('form-control')) p1.classList.add('form-control');
    if (p2 && !p2.classList.contains('form-control')) p2.classList.add('form-control');

    document.querySelectorAll('[data-toggle]').forEach(btn => {
      btn.addEventListener('click', () => {
        const key = btn.getAttribute('data-toggle');
        const input = (key === 'p1') ? p1 : p2;
        if (!input) return;
        input.type = (input.type === 'password') ? 'text' : 'password';
      });
    });
  })();
</script>
{% endblock %}
